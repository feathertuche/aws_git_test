# Stage 1: Build environment
FROM python:3.10 AS builder

WORKDIR /app

# Install build and runtime dependencies in one layer
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    gcc \
    python3-dev \
    libmariadb-dev \
    libmariadb3 \
    && rm -rf /var/lib/apt/lists/*

# Copy and install Python dependencies
COPY requirements.txt .
RUN python -m venv venv && \
    /bin/bash -c "source venv/bin/activate && \
    pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements.txt"

# Stage 2: Production environment
FROM python:3.10-slim-buster

WORKDIR /app

# Install runtime dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    mariadb-connector-c \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user
RUN useradd -m appuser && echo "appuser:appuser" | chpasswd

# Switch to the non-root user
USER appuser

# Copy virtual environment and application code from the builder stage
COPY --from=builder /app/venv /app/venv
COPY . .

# Set environment variables
ENV PYTHONUNBUFFERED 1

# Expose the port your app runs on
EXPOSE 8000

# Command to run your application
CMD ["venv/bin/gunicorn", "--workers", "2", "--threads", "4", "--bind", "0.0.0.0:8000", "--timeout", "60", "--log-level", "debug", "--limit-request-field_size", "10000", "--limit-request-fields", "100", "merge_integration.wsgi:application"]
